#!/usr/bin/env bash
DUMMY_APP_PATH=${DUMMY_APP_PATH:=/tmp/launch_base/dummy_app} && \
bundle exec rubocop -c templates/.rubocop.yml test/linters/ruby.rb && \
bundle exec reek -c templates/config.reek test/linters/ruby.rb && \
(rm -rf $DUMMY_APP_PATH || true) && \
cd .. && \
INCLUDE_TESTING_FILES=1 rails new $DUMMY_APP_PATH -m launch-base/templates/launch_base_default_template.rb && \
cd - && \
curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter && \
chmod +x ./cc-test-reporter && \
./cc-test-reporter before-build && \
DUMMY_APP_PATH=$DUMMY_APP_PATH bundle exec rake test && \
(./cc-test-reporter after-build || true) && \
cd $DUMMY_APP_PATH && \
docker build -f dockerfiles/ci/Dockerfile -t launch_base_dummy_app . && \
docker run -it -v $DUMMY_APP_PATH:/app launch_base_dummy_app bin/ci
